name: Build Python Wheels (Manual)

on:
  workflow_dispatch:
  workflow_call:

defaults:
  run:
    shell: bash --noprofile --norc -euo pipefail {0}

jobs:
  build-wheels:
    name: Build wheel (Python ${{ matrix.python }})
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    strategy:
      fail-fast: false
      matrix:
        python: ['3.13']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build multi-CUDA wheel
        run: |
          bash ci/build_multi_cuda_wheel.sh -py-version ${{ matrix.python }}

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-pynvbench-py${{ matrix.python }}
          path: wheelhouse/*.whl
          retention-days: 7
          if-no-files-found: error

  verify-wheels:
    name: Verify all wheels built successfully
    if: ${{ always() }}
    needs: build-wheels
    runs-on: ubuntu-latest
    steps:
      - name: Check build results
        run: |
          if [[ "${{ needs.build-wheels.result }}" != "success" ]]; then
            echo "Wheel builds failed!"
            exit 1
          fi
          echo "All wheels built successfully!"
